in th<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>قارئ الكتب - مكتبة النحو والإعراب</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Cairo', sans-serif; background: #F8F5F0; color: #1B4332; -webkit-font-smoothing: antialiased; margin: 0; padding: 0; overflow-x: hidden; }
        
        /* Navbar Styles */
        .navbar { position: fixed; top: 0; left: 0; right: 0; background: rgba(27, 67, 50, 0.95); backdrop-filter: blur(10px); box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); z-index: 1000; }
        .navbar-container { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; }
        .navbar-logo { font-family: 'Amiri', serif; font-size: 1.5rem; font-weight: 700; color: #D4AF37; text-decoration: none; display: flex; align-items: center; gap: 0.5rem; }
        .navbar-logo:hover { color: #FFD700; }
        .navbar-menu { display: flex; gap: 2rem; list-style: none; align-items: center; }
        .navbar-menu a { color: white; text-decoration: none; font-weight: 500; padding: 0.5rem 1rem; border-radius: 8px; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem; }
        .navbar-menu a:hover { background: rgba(255, 255, 255, 0.1); color: #FFD700; }
        .navbar-menu a.active { background: linear-gradient(135deg, #FFD700 0%, #FFC107 100%); color: #1B4332; font-weight: 700; box-shadow: 0 2px 8px rgba(255, 193, 7, 0.4); }
        .navbar-toggle { display: none; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0.5rem; }
        @media (max-width: 768px) {
            .navbar-container { padding: 1rem; }
            .navbar-toggle { display: block; }
            .navbar-menu { position: fixed; top: 60px; left: 0; right: 0; background: rgba(27, 67, 50, 0.98); flex-direction: column; gap: 0; padding: 1rem 0; transform: translateY(-100%); opacity: 0; transition: all 0.3s ease; pointer-events: none; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); }
            .navbar-menu.active { transform: translateY(0); opacity: 1; pointer-events: all; }
            .navbar-menu li { width: 100%; }
            .navbar-menu a { width: 100%; padding: 1rem 1.5rem; border-radius: 0; justify-content: flex-start; }
        }
        
        /* Top Navigation (Book Title Bar) */
        .top-nav { background: #1B4332; color: white; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 60px; z-index: 99; }
        .book-title-nav { font-family: 'Amiri', serif; font-size: 1.2rem; color: #D4AF37; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .nav-controls { display: flex; gap: 0.5rem; }
        .nav-btn { background: #2D6A4F; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; transition: all 0.3s; font-size: 0.9rem; white-space: nowrap; }
        .nav-btn:hover { background: #D4AF37; color: #1B4332; }
        .nav-btn i { margin-left: 0.3rem; }
        
        /* Layout */
        .reader-container { display: flex; min-height: calc(100vh - 120px); max-height: calc(100vh - 120px); overflow: hidden; }
        
        /* Sidebar (Table of Contents) */
        .sidebar { width: 300px; background: white; border-left: 1px solid #D8E2DC; overflow-y: auto; overflow-x: hidden; padding: 1.5rem; height: calc(100vh - 120px); position: sticky; top: 120px; -webkit-overflow-scrolling: touch; }
        .sidebar h3 { color: #1B4332; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #D4AF37; font-size: 1.1rem; }
        .toc-item { padding: 0.75rem; margin: 0.5rem 0; border-radius: 8px; cursor: pointer; transition: all 0.3s; border-right: 3px solid transparent; user-select: none; -webkit-tap-highlight-color: transparent; }
        .toc-item:hover { background: #F8F5F0; border-right-color: #D4AF37; }
        .toc-item.active { background: #D4AF37; color: white; border-right-color: #1B4332; }
        .toc-item .chapter-num { font-weight: 700; margin-left: 0.5rem; }
        
        /* Content Area */
        .content-area { flex: 1; padding: 2rem; max-width: 900px; margin: 0 auto; overflow-y: auto; height: calc(100vh - 120px); -webkit-overflow-scrolling: touch; }
        .chapter-title { font-family: 'Amiri', serif; font-size: 2rem; color: #1B4332; margin-bottom: 1.5rem; line-height: 1.4; }
        .chapter-content { background: white; padding: 3rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); font-size: 1.1rem; line-height: 2; }
        .chapter-content p { margin-bottom: 1.5rem; text-align: justify; }
        .chapter-content h4 { color: #2D6A4F; margin: 2rem 0 1rem; font-size: 1.3rem; }
        
        /* Reading Controls */
        .reading-controls { position: fixed; bottom: 2rem; left: 2rem; background: white; padding: 1rem; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); display: flex; gap: 0.5rem; flex-direction: column; z-index: 50; }
        .control-btn { background: #2D6A4F; color: white; border: none; padding: 0.75rem; border-radius: 8px; cursor: pointer; transition: all 0.3s; width: 50px; height: 50px; font-size: 1.2rem; -webkit-tap-highlight-color: transparent; }
        .control-btn:active { background: #D4AF37; color: #1B4332; transform: scale(0.95); }
        
        /* Chapter Navigation */
        .chapter-nav { display: flex; justify-content: space-between; margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #D8E2DC; gap: 1rem; }
        .chapter-nav-btn { padding: 1rem 2rem; background: #D4AF37; color: #1B4332; border: none; border-radius: 8px; font-weight: 600; transition: all 0.3s; cursor: pointer; font-family: 'Cairo', sans-serif; font-size: 1rem; -webkit-tap-highlight-color: transparent; }
        .chapter-nav-btn:active { background: #1B4332; color: #D4AF37; transform: scale(0.95); }
        .chapter-nav-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Sidebar Overlay for Mobile */
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 98; }
        .sidebar-overlay.show { display: block; }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .top-nav { padding: 0.75rem 1rem; position: sticky; top: 60px; }
            .book-title-nav { font-size: 1rem; max-width: 150px; }
            .nav-btn { padding: 0.5rem 0.75rem; font-size: 0.85rem; }
            .nav-btn span { display: none; }
            .nav-btn i { margin: 0; }
            
            .sidebar { position: fixed; right: -100%; top: 120px; width: 80%; max-width: 300px; height: calc(100vh - 120px); z-index: 99; transition: right 0.3s ease; box-shadow: -2px 0 8px rgba(0,0,0,0.2); }
            .sidebar.open { right: 0; }
            
            .content-area { padding: 1rem; width: 100%; max-width: 100%; padding-top: 1.5rem; }
            .chapter-title { font-size: 1.5rem; margin-bottom: 1rem; }
            .chapter-content { padding: 1.5rem 1rem; font-size: 1rem; line-height: 1.8; border-radius: 8px; }
            .chapter-content p { text-align: right; margin-bottom: 1rem; }
            
            .reading-controls { left: 0.5rem; bottom: 1rem; padding: 0.5rem; gap: 0.3rem; }
            .control-btn { width: 45px; height: 45px; font-size: 1.1rem; padding: 0.5rem; }
            
            .chapter-nav { flex-direction: column; gap: 0.75rem; }
            .chapter-nav-btn { width: 100%; padding: 0.75rem 1.5rem; text-align: center; }
        }
        
        /* Extra Small Phones */
        @media (max-width: 380px) {
            .book-title-nav { max-width: 100px; font-size: 0.9rem; }
            .sidebar { width: 90%; }
            .content-area { padding: 0.75rem; }
            .chapter-content { padding: 1rem 0.75rem; font-size: 0.95rem; }
            .reading-controls { bottom: 0.5rem; }
            .control-btn { width: 40px; height: 40px; font-size: 1rem; }
        }
        
        /* Tablet Optimization */
        @media (min-width: 769px) and (max-width: 1024px) {
            .sidebar { width: 250px; }
            .content-area { padding: 1.5rem; }
            .chapter-content { padding: 2rem; }
        }
    </style>
</head>
<body>
    <!-- Fixed Navbar -->
    <nav class="navbar" id="navbar">
        <div class="navbar-container">
            <a href="/" class="navbar-logo">
                <i class="fas fa-book"></i>
                <span>القاموس</span>
            </a>
            <button class="navbar-toggle" id="navbarToggle" aria-label="فتح القائمة">
                <i class="fas fa-bars"></i>
            </button>
            <ul class="navbar-menu" id="navbarMenu">
                <li><a href="/"><i class="fas fa-search"></i> البحث</a></li>
                <li><a href="/grammar/" class="active"><i class="fas fa-book-reader"></i> مكتبة علوم اللغة</a></li>
                <li><a href="/about"><i class="fas fa-info-circle"></i> عن المشروع</a></li>
                <li><a href="/methodology"><i class="fas fa-lightbulb"></i> المنهجية</a></li>
                <li><a href="/contact"><i class="fas fa-envelope"></i> تواصل معنا</a></li>
            </ul>
        </div>
    </nav>

    <div class="top-nav">
        <div class="book-title-nav" id="bookTitleNav">جاري التحميل...</div>
        <div class="nav-controls">
            <button class="nav-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i> <span>الفهرس</span></button>
            <button class="nav-btn" onclick="window.location.href='/grammar/'"><i class="fas fa-arrow-left"></i> <span>العودة</span></button>
        </div>
    </div>
    
    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
    
    <div class="reader-container">
        <div class="sidebar" id="sidebar">
            <h3><i class="fas fa-list"></i> الفهرس</h3>
            <div id="tocList">جاري تحميل الفصول...</div>
        </div>
        
        <div class="content-area">
            <h2 class="chapter-title" id="chapterTitle">جاري التحميل...</h2>
            <div class="chapter-content" id="chapterContent">
                <p>جاري تحميل محتوى الفصل...</p>
            </div>
            
            <div class="chapter-nav">
                <button class="chapter-nav-btn" id="prevBtn" onclick="navigateChapter(-1)">
                    <i class="fas fa-arrow-right"></i> الفصل السابق
                </button>
                <button class="chapter-nav-btn" id="nextBtn" onclick="navigateChapter(1)">
                    الفصل التالي <i class="fas fa-arrow-left"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div class="reading-controls">
        <button class="control-btn" onclick="changeFontSize(1)" title="تكبير الخط">
            <i class="fas fa-plus"></i>
        </button>
        <button class="control-btn" onclick="changeFontSize(-1)" title="تصغير الخط">
            <i class="fas fa-minus"></i>
        </button>
        <button class="control-btn" onclick="toggleDarkMode()" title="الوضع الليلي">
            <i class="fas fa-moon"></i>
        </button>
        <button class="control-btn" onclick="bookmark()" title="إضافة علامة">
            <i class="fas fa-bookmark"></i>
        </button>
    </div>
    
    <script>
        let currentBook = null;
        let currentChapter = 0;
        let fontSize = 1.1;
        
        // Get book ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const bookId = urlParams.get('id');
        
        async function loadBook() {
            try {
                // Load book details from individual file (much faster than loading all books)
                const response = await fetch(`/grammar/data/book-details/${bookId}.json`);
                const bookData = await response.json();
                currentBook = bookData;
                
                if (!currentBook) {
                    alert('الكتاب غير موجود');
                    window.location.href = '/grammar/';
                    return;
                }
                
                document.getElementById('bookTitleNav').textContent = currentBook.title;
                loadTableOfContents();
                loadChapter(0);
            } catch (error) {
                console.error('Error loading book:', error);
                alert('حدث خطأ في تحميل الكتاب');
                window.location.href = '/grammar/';
            }
        }
        
        function loadTableOfContents() {
            const tocList = document.getElementById('tocList');
            tocList.innerHTML = currentBook.chapters.map((chapter, index) => `
                <div class="toc-item ${index === 0 ? 'active' : ''}" onclick="loadChapter(${index}, true)">
                    <span class="chapter-num">${chapter.id}.</span>
                    ${chapter.title}
                </div>
            `).join('');
        }
        
        async function loadChapter(index, fromSidebar = false) {
            currentChapter = index;
            const chapter = currentBook.chapters[index];
            
            // Update title
            document.getElementById('chapterTitle').textContent = chapter.title;
            
            // Show loading state
            document.getElementById('chapterContent').innerHTML = '<p style="text-align: center;"><i class="fas fa-spinner fa-spin"></i> جاري تحميل الفصل...</p>';
            
            // Load chapter content
            try {
                const response = await fetch(`/grammar/data/books/${chapter.file}`);
                if (!response.ok) throw new Error('Chapter not found');
                const html = await response.text();
                
                // Add styling for Shamela book format
                document.getElementById('chapterContent').innerHTML = `
                    <style>
                        .chapter-content .PageText { font-family: 'Traditional Naskh', 'Amiri', serif; }
                        .chapter-content .title { font-weight: bold; font-size: 1.2em; color: #1B4332; }
                        .chapter-content .footnote { color: #666; font-size: 0.9em; }
                        .chapter-content table { border-collapse: collapse; margin: 1rem 0; width: 100%; }
                        .chapter-content td { border: 1px solid #ddd; padding: 0.5rem; }
                    </style>
                    ${html}
                `;
            } catch (error) {
                console.error('Error loading chapter:', error);
                document.getElementById('chapterContent').innerHTML = `
                    <p style="color: red; text-align: center;">
                        <i class="fas fa-exclamation-triangle"></i> 
                        حدث خطأ في تحميل الفصل
                    </p>
                `;
            }
            
            // Update TOC active state
            document.querySelectorAll('.toc-item').forEach((item, i) => {
                item.classList.toggle('active', i === index);
            });
            
            // Update navigation buttons
            document.getElementById('prevBtn').disabled = index === 0;
            document.getElementById('nextBtn').disabled = index === currentBook.chapters.length - 1;
            
            // Save progress
            localStorage.setItem(`book_${bookId}_progress`, index);
            
            // Close sidebar on mobile ONLY when clicking from sidebar, not when using next/prev buttons
            if (window.innerWidth <= 768 && fromSidebar) {
                toggleSidebar();
            }
            
            // Scroll content area to top
            document.querySelector('.content-area').scrollTo(0, 0);
        }
        
        function navigateChapter(direction) {
            const newIndex = currentChapter + direction;
            if (newIndex >= 0 && newIndex < currentBook.chapters.length) {
                loadChapter(newIndex);
            }
        }
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
            
            // Prevent body scroll when sidebar is open on mobile
            if (window.innerWidth <= 768) {
                document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : '';
            }
        }
        
        function changeFontSize(delta) {
            fontSize += delta * 0.1;
            fontSize = Math.max(0.8, Math.min(2, fontSize));
            document.querySelector('.chapter-content').style.fontSize = fontSize + 'rem';
        }
        
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            // You would add dark mode CSS classes
        }
        
        function bookmark() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarks') || '[]');
            const bookmark = {
                bookId: bookId,
                bookTitle: currentBook.title,
                chapterIndex: currentChapter,
                chapterTitle: currentBook.chapters[currentChapter].title,
                date: new Date().toISOString()
            };
            bookmarks.push(bookmark);
            localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
            alert('تمت إضافة علامة مرجعية!');
        }
        
        // Load book on page load
        loadBook();
        
        // Navbar mobile toggle
        const navbarToggle = document.getElementById('navbarToggle');
        const navbarMenu = document.getElementById('navbarMenu');
        if (navbarToggle) {
            navbarToggle.addEventListener('click', () => {
                const isActive = navbarMenu.classList.toggle('active');
                navbarToggle.innerHTML = isActive ? '<i class="fas fa-times"></i>' : '<i class="fas fa-bars"></i>';
            });
            navbarMenu.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', () => {
                    navbarMenu.classList.remove('active');
                    navbarToggle.innerHTML = '<i class="fas fa-bars"></i>';
                });
            });
        }
    </script>
</body>
</html>
